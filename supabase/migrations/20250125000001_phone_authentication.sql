-- Add phone number support to profiles table\n-- This migration adds phone authentication capabilities\n\n-- Add phone number field to profiles\nALTER TABLE public.profiles \n  ADD COLUMN IF NOT EXISTS phone_number TEXT UNIQUE;\n\n-- Create index for phone number lookups\nCREATE INDEX IF NOT EXISTS idx_profiles_phone_number \n  ON public.profiles(phone_number) \n  WHERE phone_number IS NOT NULL;\n\n-- Update RLS policy to allow phone-based profile creation\nCREATE POLICY \"Users can insert profile with phone\" ON public.profiles \n  FOR INSERT WITH CHECK (\n    auth.uid() = id AND \n    (phone_number IS NULL OR phone_number != '')\n  );\n\n-- Function to link WhatsApp leads to authenticated users by phone\nCREATE OR REPLACE FUNCTION link_whatsapp_to_auth_user()\nRETURNS TRIGGER AS $$\nBEGIN\n  -- If a profile is created with a phone number, \n  -- try to link existing WhatsApp leads with the same phone\n  IF NEW.phone_number IS NOT NULL THEN\n    UPDATE public.leads \n    SET auth_user_id = NEW.id\n    WHERE whatsapp_id = NEW.phone_number \n      AND auth_user_id IS NULL;\n  END IF;\n  \n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Trigger to automatically link WhatsApp leads when profile is created\nDROP TRIGGER IF EXISTS trigger_link_whatsapp_to_auth ON public.profiles;\nCREATE TRIGGER trigger_link_whatsapp_to_auth\n  AFTER INSERT OR UPDATE OF phone_number ON public.profiles\n  FOR EACH ROW\n  EXECUTE FUNCTION link_whatsapp_to_auth_user();